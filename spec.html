<!DOCTYPE html>
<html>
  <head>
    <title>Scroll Anchoring</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus: "CG-DRAFT",
          shortName: "scrollAnchoring",
          edDraftURI: "https://cdn.rawgit.com/skobes/ScrollAnchoring/master/spec.html",
          editors: [
                {   name:       "Steve Kobes",
                    url:        "",
                    company:    "Google",
                    companyURL: "https://www.google.com/" },
                {   name:       "Yash Malik",
                    url:        "",
                    company:    "Google",
                    companyURL: "https://www.google.com/" },
          ],
          otherLinks: [{
            key: 'Participation',
            data: [
                {
                    value: 'GitHub repository',
                    href: 'https://github.com/skobes/ScrollAnchoring'
                }, {
                    value: 'Feedback / discussion in the WICG',
                    href: 'https://discourse.wicg.io/t/proposal-scroll-anchoring/1752'
                }
             ]
          }],
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      <p>
        Changes in DOM elements above the visible region of a scroller can result
        in the page moving while the user is in the middle of consuming the content.
      </p>
      <p>
        This spec proposes a mechanism to mitigate this jarring user experience by
        keeping track of the position of an anchor node and adjusting the scroll
        offset accordingly.
      </p>
      <p>
        This spec also proposes an API for web developers to opt-out of this behavior.
      </p>
    </section>

    <section id="intro" class="informative">
      <h2>Introduction</h2>
      <p>
        Today, users of the web are often distracted by content moving around due to
        changes that occur outside the viewport. Examples include script inserting an
        iframe containing an ad, or non-sized images loading on a slow network.
      </p>
      <p>
        Historically the browser's default behavior has been to preserve the absolute
        scroll position when such changes occur. This means that to avoid shifting
        content, the webpage can attempt to reserve space on the page for anything
        that will load later. In practice, few websites do this consistently.
      </p>
      <p>
        Scroll anchoring aims to minimize surprising content shifts. It does this by
        adjusting the scroll position to compensate for the changes outside the
        viewport.
      </p>
    </section>
    <section dfn-for="ScrollAnchoring">
      <h2>Description</h2>
      <p>
        Scroll anchoring works by selecting a DOM node (the <dfn>anchor node</dfn>) whose
        movement is used to determine the adjustment to the scroll position.
      </p>
      <section>
        <h3>Anchor Node Selection</h3>
        <p>
          The user agent aims to select an anchor node that is deep in the DOM and close to the top
          edge of the <a id="ref-for-viewport-1">viewport</a>. This maximizes the amount of offscreen content whose
          changes the user agent will successfully compensate for, while avoiding undesired scrolling
          when important content loads within the viewport (for example, upon clicking a
          "Read More" link).
        </p>
        <p>
          The anchor node may be either a text node or an element.
        </p>
        <p>
          The <dfn id="anchoring-algorithm">algorithm to select an anchor node for a scrollable area </dfn>(either a
          document or an element with scrollable overflow) is as follows:
          <ol>
            <li>
              If the scrollable area is created by an element whose computed value of the
              <a href="#overflow-anchor">overflow-anchor</a> property is
              <a href="#overflow-anchor-none">none</a>, then do not select an anchor node.
            </li>
            <li>
              Otherwise, walk the DOM within the
              <a href="https://drafts.csswg.org/cssom-view/#scrolling-box">scrollable area</a>.
            </li>
            <li>
              For each element E encountered by the walk
              <ol>
                <li>
                  If E is an <a href="#unsuitable-anchor" id="ref-for-unsuitable-anchor-1">unsuitable anchor node</a>, skip over E and its descendents.
                </li>
                <li>
                  Otherwise, compare its bounds to the scrollable area's visible region.
                  <ol>
                    <li>If E is <a id="ref-for-fully-visible-1">fully visible</a>, terminate the walk and use E as the anchor node.</li>
                    <li>If E is <a id="ref-for-fully-clipped-1">fully clipped</a>, skip over E and its descendents.</li>
                    <li>
                      If E is <a id="ref-for-partially-visible-1">partially visible</a>, mark it as a "candidate"
                      and descend into its children. If the walk reaches the end of E without finding
                      another anchor node, use E as the anchor node. (Deeper nodes are preferred
                      in this case to avoid the failure mode of content being inserted
                      inside the anchor node but outside the viewport.)
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
          </ol>
        </p>
        <p>
          Conceptually, a new anchor node is computed for every scrollable area whenever the scroll position of
          any scrollable area changes. (As a performance optimization, the implementation may wait until the
          anchor node is needed before computing it.)
        </p>
        <p>
          The <dfn id="viewport"> viewport</dfn> is the visible region of the <a href="https://drafts.csswg.org/cssom-view/#scrolling-box">scrollable area</a>.
        </p>
        <p>
          A DOM element E it an <dfn id="unsuitable-anchor">unsuitable anchor node</dfn> if any of the following conditions
          holds:
          <ul>
            <li>
              E's computed value of the <a href="https://drafts.csswg.org/css-position-3/#propdef-position">position</a> property is <a href="https://drafts.csswg.org/css-position-3/#valdef-position-fixed">fixed</a>.
            </li>
            <li>
              E's computed value of the <a href="https://drafts.csswg.org/css-position-3/#propdef-position">position</a> property is <a href="https://drafts.csswg.org/css-position-3/#valdef-position-absolute">absolute</a> and E's
              <a href="https://drafts.csswg.org/css-display-3/#containing-block">containing block</a>
              is an ancestor of the scrollable area.
            </li>
            <li>
              E's computed value of the <a href="#overflow-anchor">overflow-anchor</a>
              property is <a href="#overflow-anchor-none">none</a>.
            </li>
          </ul>
        </p>
        <p>
          A DOM element E is <dfn id="fully-visible">fully visible </dfn> if it is entirely
          within the <a id="ref-for-viewport-2">viewport</a>.
        </p>
        <p>
          A DOM element E is <dfn id="fully-clipped">fully clipped </dfn> if it is entirely
          outside the <a id="ref-for-viewport-3">viewport</a>.
        </p>
        <p>
          A DOM element E is <dfn id="partially-visible">partially visible </dfn> if it is
          not <a id="ref-for-fully-visible-2">fully visible</a> and not
          <a id="ref-for-fully-clipped-2"> fully clipped </a>
        </p>
        <p>
      </section>
      <section>
        <h3>Scroll Adjustment</h3>
        <p>
          If an anchor node was selected, then when the anchor node moves,
          the browser computes its previous offset <code>y0</code> and
          its new offset <code>y1</code> from the top of the scrolling content in the
          <a href="https://www.w3.org/TR/css-writing-modes-3/#block-flow-direction">block
          flow direction</a>. It then queues an adjustment to the scroll position
          of <code>y1 - y0</code>, in the block flow direction, to be performed at the end of the
          <a>suppression window</a>.
        </p>
        <h4>Suppression Window</h4>
        <p>
          Every movement of an anchor node occurs within a window of time called the
          <dfn id="suppression-window">suppression window</dfn>, defined as follows:
          <ul>
            <li>The suppression window begins at the start of the current iteration of the
            <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#processing-model-8">HTML Processing Model</a> event loop, or at the end of the most recently completed suppression window,
            whichever is more recent.</li>
            <li>The suppression window ends at the end of the current iteration of the
            <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#processing-model-8">HTML Processing Model</a> event loop,
            or immediately before the next operation whose result or side effects
            would differ as a result of a change in the scroll position (for example,
            an invocation of
            <a href="https://www.w3.org/TR/cssom-view-1/#dom-element-getboundingclientrect">getBoundingClientRect</a>), whichever comes sooner.
            </li>
          </ul>
          More than one anchor node movement may occur within the same suppression window.
        </p>
        <p>
          At the end of a suppression window, the user agent performs all scroll
          adjustments that were queued during the window and not suppressed by any
          <a>suppression trigger</a> during the window.
        </p>
        <h4>Suppression Triggers</h4>
        <p>
          A <dfn id="suppression-trigger">suppression trigger</dfn> is an operation that
          suppresses the scroll anchoring adjustment for an anchor node movement, if it
          occurs within the suppression window for that movement. These triggers are:
          <ul>
            <li>
              Any change to the computed value of any of the following properties, on any
              element in the path from the anchor node to the scrollable element (or
              document), inclusive of both:
              <ul>
                <li><a href="https://drafts.csswg.org/css21/visuren.html#position-props">box offset properties</a></li>
                <li><a href="https://drafts.csswg.org/css21/box.html#margin-properties">margin properties</a></li>
                <li><a href="https://drafts.csswg.org/css21/box.html#padding-properties">padding properties</a></li>
                <li><a href="https://drafts.csswg.org/css21/visudet.html#propdef-width">width</a>,
                  <a href="https://drafts.csswg.org/css21/visudet.html#propdef-height">height</a>,
                  <a href="https://drafts.csswg.org/css21/visudet.html#min-max-widths">min-width and max-width</a>,
                  <a href="https://drafts.csswg.org/css21/visudet.html#min-max-heights">min-height and max-height</a></li>
                <li><a href="https://drafts.csswg.org/css-position-3/#propdef-position">position</a></li>
                <li><a href="https://drafts.csswg.org/css-transforms-1/#propdef-transform">transform</a></li>
              </ul>
            </li>
            <li>
              Any change to the computed value of the
              <a href="https://drafts.csswg.org/css-position-3/#propdef-position">position</a>
              property on any element within the scrollable element (or document), such that
              the element acquires or ceases to have an out-of-flow position
              (<a href="https://drafts.csswg.org/css-position-3/#fixed-pos">fixed</a> or
              <a href="https://drafts.csswg.org/css-position-3/#abs-pos">absolute</a>).
              Note that this trigger applies regardless of whether the modified element is
              on the path from the anchor node to the scrollable element.
            </li>
          </ul>
        </p>
      </section>
    </section>
    <section>
      <h2>Exclusion API</h2>
      <p>
        Scroll anchoring aims to be the default mode of behavior when launched, so that
        users benefit from it even on legacy content. A CSS property
        <dfn id="overflow-anchor"><code>overflow-anchor</code></dfn> can disable
        scroll anchoring in part or all of a webpage (opt out), or exclude portions
        of the DOM from the anchor node selection algorithm.
        This property supports the following values when applied to an element E:
      </p>
      <ul>
        <li>
            <dfn><code>overflow-anchor: visible</code></dfn> declares that the DOM subtree
            rooted at E is eligible to participate in the <a href="#anchoring-algorithm"
            id="ref-for-anchoring-algorithm-1">anchor node selection algorithm</a>
            for any scrollable area created by E or an ancestor of E.
        </li>
        <li>
            <dfn id="overflow-anchor-none"><code>overflow-anchor: none</code></dfn>
            declares that the DOM subtree rooted at E is <em>not</em> eligible to
            participate in the <a href="#anchoring-algorithm"
            id="ref-for-anchoring-algorithm-1">anchor node selection algorithm</a>
            for any scrollable area created by E or an ancestor of E.
        </li>
        <li>
            <dfn><code>overflow-anchor: auto</code></dfn> invokes the user agent's default behavior for the
            element. With the launch of scroll anchoring this will be equivalent
            to <code>visible</code>, but is subject to future modification.
        </li>
      </ul>
      <p class="issue">
        The pairing of <code>visible</code> with <code>none</code> is awkward.
        There may be better names for these values.
      </p>
      <div class="note">
        The <code>overflow-anchor</code> property is also proposed (with different values) for
        <a href="http://tabatkins.github.io/specs/css-sticky-scrollbars/">CSS Sticky Scrollbars</a>.
        This feature is distinct from scroll anchoring, but shares the notion of
        adjusting scroll position in response to content changes.
      </div>
      <p>
        The <code>overflow-anchor</code> property is not inherited.
      </p>
    </section>

    <h2 id="references">References</h2>
    <h3 id="normative">Normative References</h3>
    <dl>
      <dt id="biblio-cssom-view-1">[CSSOM-VIEW-1]
      <dd>Simon Pieters. <a href="https://drafts.csswg.org/cssom-view/">CSSOM View Module</a>. 17 March 2016. WD. URL: <a href="https://drafts.csswg.org/cssom-view/">https://drafts.csswg.org/cssom-view/</a>
    </dl>
  </body>
</html>
